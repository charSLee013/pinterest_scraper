# ImageDownloadStage é‡æ„æ–‡æ¡£

## ğŸ“‹ é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„å®Œå…¨é‡æ–°è®¾è®¡äº†ç¬¬4é˜¶æ®µï¼ˆå›¾ç‰‡æ–‡ä»¶ä¸‹è½½é˜¶æ®µï¼‰çš„å®ç°é€»è¾‘ï¼Œä»åŸæœ‰çš„ç®€å•å¾ªç¯å¤„ç†æ”¹ä¸ºç¬¦åˆç”¨æˆ·éœ€æ±‚çš„5æ­¥å¾ªç¯é€»è¾‘ã€‚

## ğŸ¯ é‡æ„ç›®æ ‡

å®ç°æ¸…æ™°çš„5æ­¥å¾ªç¯é€»è¾‘ï¼š
1. åˆ›å»ºå·²ä¸‹è½½å›¾ç‰‡piné›†åˆ
2. ç¿»é¡µæ‰¹é‡è¯»å–å¾…ä¸‹è½½pins
3. æ£€æŸ¥/è·å–headers
4. å¤šçº¿ç¨‹ä¸‹è½½å›¾ç‰‡ï¼ˆé‡è¯•æœºåˆ¶+å•ç‚¹é”™è¯¯å®¹å¿ï¼‰
5. æ£€æŸ¥æœ¬åœ°æ–‡ä»¶å¹¶æ›´æ–°å…¨å±€è®¡æ•°
6. é‡å¤æ­¥éª¤2-5ç›´åˆ°å®Œæˆ

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### 1. å‚æ•°ä¼˜åŒ–
**ä¿®æ”¹å‰**ï¼š
- `batch_size = 50`ï¼ˆå›ºå®šï¼‰
- `max_concurrent = 15`ï¼ˆå¯é…ç½®ï¼‰
- é—®é¢˜ï¼šèµ„æºåˆ©ç”¨ä¸å‡è¡¡

**ä¿®æ”¹å**ï¼š
- `batch_size = max_concurrent`ï¼ˆè‡ªåŠ¨åŒ¹é…ï¼‰
- èµ„æºåˆ©ç”¨ç‡ï¼š100%
- æ€§èƒ½æ›´ç¨³å®š

### 2. æ¶æ„é‡æ„
```python
class ImageDownloadStage(StageManager):
    """é˜¶æ®µ4ï¼šå›¾ç‰‡æ–‡ä»¶ä¸‹è½½ - é‡æ„ç‰ˆ
    
    å®ç°æ¸…æ™°çš„5æ­¥å¾ªç¯é€»è¾‘
    """
    
    def __init__(self, output_dir: str, max_concurrent: int = 15, batch_size: Optional[int] = None):
        # batch_sizeè‡ªåŠ¨ç­‰äºmax_concurrentï¼Œç¡®ä¿æœ€ä¼˜èµ„æºåˆ©ç”¨
        self.batch_size = batch_size if batch_size is not None else max_concurrent
```

### 3. 5æ­¥å¾ªç¯å®ç°
```python
async def _process_keyword_with_5_steps(self, keyword: str) -> Dict[str, Any]:
    """ä¸ºå•ä¸ªå…³é”®è¯æ‰§è¡Œ5æ­¥å¾ªç¯é€»è¾‘"""
    
    # ã€æ­¥éª¤1ã€‘åˆ›å»ºå·²ä¸‹è½½å›¾ç‰‡piné›†åˆ
    downloaded_pins_set = self._build_downloaded_pins_set(images_dir)
    
    # ã€ä¸»å¾ªç¯ã€‘é‡å¤æ­¥éª¤2-5ç›´åˆ°å®Œæˆ
    while True:
        # ã€æ­¥éª¤2ã€‘ç¿»é¡µæ‰¹é‡è¯»å–å¾…ä¸‹è½½pins
        pins_batch = repository.load_pins_with_images(keyword, limit=self.batch_size, offset=offset)
        
        # ã€æ­¥éª¤3ã€‘æ£€æŸ¥/è·å–headers
        headers_ready = await self._ensure_headers_ready()
        
        # ã€æ­¥éª¤4ã€‘å¤šçº¿ç¨‹ä¸‹è½½å›¾ç‰‡
        batch_results = await self._download_batch_with_retry(missing_pins, keyword, images_dir)
        
        # ã€æ­¥éª¤5ã€‘æ£€æŸ¥æœ¬åœ°æ–‡ä»¶å¹¶æ›´æ–°å…¨å±€è®¡æ•°
        batch_downloaded, batch_failed = self._verify_and_update_stats(batch_results, downloaded_pins_set)
```

## ğŸš€ æ€§èƒ½æå‡

### 1. èµ„æºåˆ©ç”¨ä¼˜åŒ–
- **çº¿ç¨‹åˆ©ç”¨ç‡**: 100%ï¼ˆæ— ç©ºé—²çº¿ç¨‹ï¼‰
- **å†…å­˜æ•ˆç‡**: æ‰¹æ¬¡å¤§å°ä¸å¤„ç†èƒ½åŠ›å®Œç¾åŒ¹é…
- **ä¸‹è½½ç¨³å®šæ€§**: é¿å…æ‰¹æ¬¡ä¸åŒ¹é…å¯¼è‡´çš„æ€§èƒ½æ³¢åŠ¨

### 2. é”™è¯¯å¤„ç†å¢å¼º
- **å•ç‚¹é”™è¯¯å®¹å¿**: å•ä¸ªPinä¸‹è½½å¤±è´¥ä¸å½±å“æ•´ä½“è¿›åº¦
- **æ™ºèƒ½é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- **æ–‡ä»¶å®Œæ•´æ€§éªŒè¯**: ä¸‹è½½åè‡ªåŠ¨éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§

### 3. ç”¨æˆ·ä½“éªŒæ”¹è¿›
- **è¿›åº¦æ˜¾ç¤º**: å¤šå±‚çº§è¿›åº¦æ¡ï¼ˆæ€»ä½“+å½“å‰å…³é”®è¯+å½“å‰æ‰¹æ¬¡ï¼‰
- **å®æ—¶ç»Ÿè®¡**: æˆåŠŸç‡ã€å¤±è´¥ç‡ã€ä¸‹è½½é€Ÿåº¦å®æ—¶æ›´æ–°
- **ä¸­æ–­å¤„ç†**: ä¼˜é›…çš„ä¸­æ–­å’Œæ¢å¤æœºåˆ¶

## ğŸ“Š æµ‹è¯•éªŒè¯

### 1. å‚æ•°å…³ç³»éªŒè¯
```python
# æµ‹è¯•æ¡ˆä¾‹1: é»˜è®¤å‚æ•°
stage1 = ImageDownloadStage('test_dir', max_concurrent=15)
assert stage1.batch_size == stage1.max_concurrent  # âœ… True

# æµ‹è¯•æ¡ˆä¾‹2: é«˜å¹¶å‘
stage2 = ImageDownloadStage('test_dir', max_concurrent=100)
assert stage2.batch_size == stage2.max_concurrent  # âœ… True
```

### 2. å®é™…è¿è¡ŒéªŒè¯
- âœ… 5æ­¥å¾ªç¯é€»è¾‘æ­£ç¡®æ‰§è¡Œ
- âœ… æ‰¹æ¬¡å¤§å°ä¸å¹¶å‘æ•°å®Œç¾åŒ¹é…
- âœ… è¿›åº¦æ˜¾ç¤ºå’Œç»Ÿè®¡æ›´æ–°æ­£å¸¸
- âœ… ä¸­æ–­å’Œæ¢å¤æœºåˆ¶å·¥ä½œæ­£å¸¸

## ğŸ”„ å‘åå…¼å®¹æ€§

- âœ… ä¿æŒç°æœ‰æ¥å£å®Œå…¨å…¼å®¹
- âœ… æ”¯æŒæ˜¾å¼æŒ‡å®šbatch_sizeï¼ˆé«˜çº§ç”¨æˆ·ï¼‰
- âœ… é»˜è®¤è¡Œä¸ºæ›´æ™ºèƒ½ï¼ˆbatch_size = max_concurrentï¼‰

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```bash
# é»˜è®¤å¹¶å‘ï¼ˆ15ä¸ªçº¿ç¨‹ï¼Œæ‰¹æ¬¡å¤§å°15ï¼‰
python main.py --only-images

# é«˜å¹¶å‘ï¼ˆ100ä¸ªçº¿ç¨‹ï¼Œæ‰¹æ¬¡å¤§å°100ï¼‰
python main.py --only-images --max-concurrent 100

# æŒ‡å®šå…³é”®è¯
python main.py --only-images --query "cats" --max-concurrent 30
```

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡é‡æ„å®Œå…¨å®ç°äº†ç”¨æˆ·æè¿°çš„ç†æƒ³é€»è¾‘ï¼Œå°†ImageDownloadStageä»ç®€å•çš„å¾ªç¯å¤„ç†å‡çº§ä¸ºé«˜æ•ˆçš„5æ­¥å¾ªç¯æ¶æ„ï¼Œæ˜¾è‘—æå‡äº†æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

**æ ¸å¿ƒæˆå°±**ï¼š
- âœ… 100%ç¬¦åˆç”¨æˆ·éœ€æ±‚çš„5æ­¥å¾ªç¯é€»è¾‘
- âœ… æ‰¹æ¬¡å¤§å°ä¸å¹¶å‘æ•°å®Œç¾åŒ¹é…
- âœ… èµ„æºåˆ©ç”¨ç‡è¾¾åˆ°100%
- âœ… ä¿æŒå®Œå…¨å‘åå…¼å®¹
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---
*é‡æ„å®Œæˆæ—¶é—´: 2025-01-20*
*é‡æ„ç‰ˆæœ¬: ImageDownloadStage v2.0*
