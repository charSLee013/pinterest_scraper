# 自动数据库修复功能

## 🚀 功能概述

BatchAtomicBase64Converter现在具备了强大的自动数据库修复功能，能够在运行时自动检测并修复从运行中复制的数据库文件问题，无需手动干预。

## 🔧 核心特性

### 1. **自动检测机制**
- ✅ **损坏数据库自动检测**：在处理前自动检测数据库完整性
- ✅ **WAL文件状态检查**：检测WAL文件大小和状态异常
- ✅ **文件锁定检测**：识别文件锁定和访问问题
- ✅ **多层次检测策略**：快速检查 → 完整检查 → 深度诊断

### 2. **自动修复流程**
- ✅ **数据抢救**：从损坏数据库中抢救所有可用数据
- ✅ **多重备份**：自动创建多个备份确保数据安全
- ✅ **干净重建**：创建优化的新数据库文件
- ✅ **安全替换**：处理Windows文件锁定，自动重试

### 3. **用户体验优化**
- ✅ **进度显示**：实时显示数据抢救进度
- ✅ **详细日志**：完整记录修复过程
- ✅ **无缝继续**：修复完成后自动继续Base64转换
- ✅ **状态反馈**：清晰的修复状态信息

## 📊 工作流程

```
数据库检查 → 问题检测 → 自动修复 → 继续转换
     ↓           ↓           ↓           ↓
  健康检查    损坏检测    数据抢救    Base64转换
     ↓           ↓           ↓           ↓
  正常处理    备份原文件   重建数据库   完成处理
```

## 🔍 检测机制详解

### 1. **数据库文件状态检测**
```python
def _detect_database_issues(self, db_path: str, keyword: str) -> bool:
    # 检查文件存在性
    # 检查WAL/SHM文件状态
    # 快速连接测试
    # 完整性检查
```

### 2. **问题类型识别**
- **WAL文件过大**：> 1MB的WAL文件可能有问题
- **连接失败**：数据库文件锁定或损坏
- **完整性检查失败**：`PRAGMA quick_check` 返回错误
- **访问异常**：文件权限或锁定问题

## 🚑 自动修复流程

### 阶段1：多重备份
```python
def _create_multiple_backups(self, db_path: str, keyword: str) -> bool:
    # 备份1：损坏数据库备份 (.corrupted_backup)
    # 备份2：时间戳备份 (.backup_YYYYMMDD_HHMMSS)
```

### 阶段2：数据抢救
```python
async def _auto_rescue_data(self, corrupted_db_path: str, recovered_db_path: str, keyword: str) -> int:
    # 创建新数据库结构
    # 逐行读取损坏数据库
    # 批量插入抢救数据
    # 显示抢救进度
```

### 阶段3：重建数据库
```python
def _create_clean_database_auto(self, recovered_db_path: str, new_db_path: str, keyword: str) -> bool:
    # 复制抢救的数据
    # 设置安全PRAGMA
    # 重建索引
    # 清理碎片
```

### 阶段4：安全替换
```python
async def _safe_replace_database(self, original_db_path: str, new_db_path: str, keyword: str) -> bool:
    # 删除WAL/SHM文件
    # 多次重试替换
    # 处理文件锁定
    # 验证替换结果
```

## 📈 性能特性

### 1. **批量数据抢救**
- **批次大小**：1000条记录/批次
- **进度显示**：实时显示抢救进度
- **内存优化**：批量提交减少内存使用
- **错误跳过**：自动跳过损坏的数据行

### 2. **Windows兼容性**
- **文件锁定处理**：自动重试机制
- **指数退避**：重试间隔逐渐增加
- **辅助文件清理**：自动删除WAL/SHM文件
- **权限处理**：处理文件权限问题

## 🎯 使用示例

### 自动修复模式（推荐）
```bash
# 直接运行，遇到损坏数据库会自动修复
uv run python .\main.py --only-images --verbose
```

### 输出示例
```
🔍 开始增强数据库健康检查: room
⚠️ 检测到数据库问题，开始自动修复: room
🚑 开始自动修复损坏的数据库: room
💾 创建多重备份: room
🚑 开始自动数据抢救: room
📊 预计抢救记录数: 47,068
抢救数据room: 100.0% |████████████████████| 47,068/47,068 [1,234.5record/s, 剩余:00:00]
✅ 数据抢救完成: room, 成功抢救 47,068 条记录
🔧 创建干净的新数据库: room
🔄 安全替换数据库文件: room
✅ 数据库自动修复完成: room
✅ 增强数据库健康检查完成: room
📊 关键词 room: 发现 44,645 个base64编码Pin
批量原子转换room: 100.0% |████████████████████| 44,645/44,645 [315.1pin/s, 剩余:00:00]
✅ 关键词 room: 批量原子转换完成 44,645/44,645 个Pin
```

## 🛡️ 安全保障

### 1. **数据安全**
- ✅ **多重备份**：原文件 + 时间戳备份
- ✅ **原子操作**：修复过程中的事务保证
- ✅ **回滚机制**：修复失败时保留原文件
- ✅ **验证检查**：修复后的完整性验证

### 2. **错误处理**
- ✅ **异常捕获**：全面的异常处理机制
- ✅ **详细日志**：完整的错误追踪信息
- ✅ **优雅降级**：修复失败时的处理策略
- ✅ **用户指导**：清晰的错误信息和建议

## 🔧 配置选项

### 转换器配置
```python
converter = BatchAtomicBase64Converter(
    output_dir="./output",
    batch_size=1024,        # 转换批次大小
    max_workers=8           # 计算线程数
)
```

### 修复相关配置
- **抢救批次大小**：1000条记录/批次（固定）
- **重试次数**：最多5次替换重试
- **重试延迟**：2秒起始，指数退避
- **超时设置**：数据库连接60秒超时

## 📊 监控和日志

### 关键日志信息
```
🔍 开始增强数据库健康检查: {keyword}
⚠️ 检测到数据库问题，开始自动修复: {keyword}
🚑 开始自动数据抢救: {keyword}
📊 预计抢救记录数: {count:,}
✅ 数据抢救完成: {keyword}, 成功抢救 {count:,} 条记录
🔧 创建干净的新数据库: {keyword}
🔄 安全替换数据库文件: {keyword}
✅ 数据库自动修复完成: {keyword}
```

### 错误日志
```
❌ 数据库健康检查失败 {keyword}: {error}
❌ 自动修复失败: {keyword}
❌ 数据抢救失败 {keyword}: {error}
❌ 创建新数据库失败 {keyword}: {error}
❌ 数据库替换失败: {keyword}
```

## 🎉 总结

增强的自动修复功能让BatchAtomicBase64Converter具备了工业级的可靠性：

✅ **完全自动化**：无需手动干预，自动检测和修复  
✅ **数据安全**：多重备份和原子操作保证  
✅ **高效抢救**：批量处理和进度显示  
✅ **Windows兼容**：处理文件锁定和权限问题  
✅ **无缝体验**：修复完成后自动继续处理  

现在您可以放心地运行 `uv run python .\main.py --only-images`，即使遇到从运行中复制的损坏数据库文件，系统也会自动修复并继续处理！
